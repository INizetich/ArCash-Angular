<div class="formulario">
    <!-- Formulario de registro -->
    @if(!registrationSuccessful){
        <h2>Registrarse</h2>

        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" novalidate>

        <div class="input-container">
            <label>Nombre</label>
            <div class="input-wrapper">
                <input class="effect-1" 
                       type="text" 
                       formControlName="nombre" 
                       placeholder="Ingrese su nombre"
                       maxlength="50">
                <span class="focus-border"></span>
            </div>
            <div>
                @if (registerForm.get('nombre')?.invalid && registerForm.get('nombre')?.touched) {
                    <div class="error-container">
                        @if (registerForm.get('nombre')?.hasError('required')) {
                            <small class="error-message">El nombre es requerido.</small>
                        }
                        @if (registerForm.get('nombre')?.hasError('pattern')) {
                            <small class="error-message">El nombre solo puede contener letras y espacios.</small>
                        }
                        @if (registerForm.get('nombre')?.hasError('minlength')) {
                            <small class="error-message">El nombre debe tener al menos 2 caracteres.</small>
                        }
                        @if (registerForm.get('nombre')?.hasError('maxlength')) {
                            <small class="error-message">El nombre no puede tener más de 50 caracteres.</small>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="input-container">
            <label>Apellido</label>
            <div class="input-wrapper">
                <input class="effect-1" 
                       type="text" 
                       formControlName="apellido" 
                       placeholder="Ingrese su apellido"
                       maxlength="50">
                <span class="focus-border"></span>
            </div>
            <div>
                @if (registerForm.get('apellido')?.invalid && registerForm.get('apellido')?.touched) {
                    <div class="error-container">
                        @if (registerForm.get('apellido')?.hasError('required')) {
                            <small class="error-message">El apellido es requerido.</small>
                        }
                        @if (registerForm.get('apellido')?.hasError('pattern')) {
                            <small class="error-message">El apellido solo puede contener letras y espacios.</small>
                        }
                        @if (registerForm.get('apellido')?.hasError('minlength')) {
                            <small class="error-message">El apellido debe tener al menos 2 caracteres.</small>
                        }
                        @if (registerForm.get('apellido')?.hasError('maxlength')) {
                            <small class="error-message">El apellido no puede tener más de 50 caracteres.</small>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="input-container">
            <label>D.N.I</label>
            <div class="input-wrapper">
                <input class="effect-1" 
                       type="text" 
                       formControlName="dni" 
                       maxlength="8" 
                       placeholder="12345678"
                       (input)="onDniInput($event)">
                <span class="focus-border"></span>
            </div>
            <div>
                @if (registerForm.get('dni')?.invalid && registerForm.get('dni')?.touched) {
                    <div class="error-container">
                        @if (registerForm.get('dni')?.hasError('required')) {
                            <small class="error-message">El DNI es requerido.</small>
                        }
                        @if (registerForm.get('dni')?.hasError('pattern')) {
                            <small class="error-message">Debe ser un DNI de 8 dígitos sin puntos.</small>
                        }
                        @if (registerForm.get('dni')?.hasError('minlength')) {
                            <small class="error-message">El DNI debe tener exactamente 8 dígitos.</small>
                        }
                        @if (registerForm.get('dni')?.hasError('maxlength')) {
                            <small class="error-message">El DNI debe tener exactamente 8 dígitos.</small>
                        }
                    </div>
                }
            </div>
        </div>

        <div formGroupName="emails" class="email-group">
            <div class="input-container">
                <label>Email</label>
                <div class="input-wrapper">
                    <input class="effect-1" 
                           type="email" 
                           formControlName="email" 
                           placeholder="ejemplo@correo.com"
                           maxlength="100">
                    <span class="focus-border"></span>
                </div>
                <div>
                    @if (registerForm.get('emails.email')?.invalid && registerForm.get('emails.email')?.touched) {
                        <div class="error-container">
                            @if (registerForm.get('emails.email')?.hasError('required')) {
                                <small class="error-message">El email es requerido.</small>
                            }
                            @if (registerForm.get('emails.email')?.hasError('email')) {
                                <small class="error-message">Ingrese un formato de email válido.</small>
                            }
                            @if (registerForm.get('emails.email')?.hasError('pattern')) {
                                <small class="error-message">El formato del email no es válido.</small>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="input-container">
                <label>Confirmar Email</label>
                <div class="input-wrapper">
                    <input class="effect-1" 
                           type="email" 
                           formControlName="confirmEmail" 
                           placeholder="Confirme su email"
                           maxlength="100">
                    <span class="focus-border"></span>
                </div>
                <div>
                    @if (registerForm.get('emails.confirmEmail')?.invalid && registerForm.get('emails.confirmEmail')?.touched) {
                        <div class="error-container">
                            @if (registerForm.get('emails.confirmEmail')?.hasError('required')) {
                                <small class="error-message">La confirmación del email es requerida.</small>
                            }
                            @if (registerForm.get('emails.confirmEmail')?.hasError('email')) {
                                <small class="error-message">Ingrese un formato de email válido.</small>
                            }
                        </div>
                    }
                    @if (registerForm.get('emails')?.hasError('emailMismatch') && registerForm.get('emails.confirmEmail')?.touched) {
                        <div class="error-container">
                            <small class="error-message">Los emails no coinciden.</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div formGroupName="passwords" class="password-group">
            <div class="input-container">
                <label>Contraseña</label>
                <div class="input-wrapper password-wrapper">
                    <input class="effect-1" 
                           [type]="showPassword ? 'text' : 'password'" 
                           formControlName="password"
                           placeholder="8+ caracteres: mayúscula, minúscula, número, especial">
                    <button type="button" class="password-toggle" (click)="togglePasswordVisibility()" [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            @if (!showPassword) {
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            }
                            @if (showPassword) {
                                <path d="m1 1 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M6.71 6.71C4.03 8.75 2 12 2 12s3 6 10 6c1.35 0 2.6-.3 3.71-.9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M14 14.12c-.55.19-1.14.29-1.76.29-2.48 0-4.5-2.02-4.5-4.5 0-.62.1-1.21.29-1.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 7c2.76 0 5 2.24 5 5 0 .28-.02.56-.07.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            }
                        </svg>
                    </button>
                    <span class="focus-border"></span>
                </div>
                <div>
                    @if (registerForm.get('passwords.password')?.invalid && registerForm.get('passwords.password')?.touched) {
                        <div class="error-container">
                            @if (registerForm.get('passwords.password')?.hasError('required')) {
                                <small class="error-message">La contraseña es requerida.</small>
                            }
                            @if (registerForm.get('passwords.password')?.hasError('minLength')) {
                                <small class="error-message">Debe tener al menos 8 caracteres.</small>
                            }
                            @if (registerForm.get('passwords.password')?.hasError('lowercase')) {
                                <small class="error-message">Debe contener al menos una letra minúscula.</small>
                            }
                            @if (registerForm.get('passwords.password')?.hasError('uppercase')) {
                                <small class="error-message">Debe contener al menos una letra mayúscula.</small>
                            }
                            @if (registerForm.get('passwords.password')?.hasError('number')) {
                                <small class="error-message">Debe contener al menos un número.</small>
                            }
                            @if (registerForm.get('passwords.password')?.hasError('specialChar')) {
                                <small class="error-message">Debe contener al menos un carácter especial (!@#$%^&*...).</small>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="input-container">
                <label>Confirmar Contraseña</label>
                <div class="input-wrapper password-wrapper">
                    <input class="effect-1" 
                           [type]="showConfirmPassword ? 'text' : 'password'" 
                           formControlName="confirmPassword"
                           placeholder="Repita su contraseña">
                    <button type="button" class="password-toggle" (click)="toggleConfirmPasswordVisibility()" [attr.aria-label]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            @if (!showConfirmPassword) {
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            }
                            @if (showConfirmPassword) {
                                <path d="m1 1 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M6.71 6.71C4.03 8.75 2 12 2 12s3 6 10 6c1.35 0 2.6-.3 3.71-.9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M14 14.12c-.55.19-1.14.29-1.76.29-2.48 0-4.5-2.02-4.5-4.5 0-.62.1-1.21.29-1.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 7c2.76 0 5 2.24 5 5 0 .28-.02.56-.07.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            }
                        </svg>
                    </button>
                    <span class="focus-border"></span>
                </div>
                <div>
                    @if (registerForm.get('passwords')?.hasError('passwordMismatch') && registerForm.get('passwords.confirmPassword')?.touched) {
                        <div class="error-container">
                            <small class="error-message">Las contraseñas no coinciden.</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="input-container" >
            <label>Nombre de usuario</label>
            <div class="input-wrapper">
                <input class="effect-1"  
                       type="text" 
                       formControlName="alias"
                       placeholder="usuario123"
                       maxlength="10">
                <span class="focus-border"></span>
            </div>
            <div>
                @if (registerForm.get('alias')?.invalid && registerForm.get('alias')?.touched) {
                    <div class="error-container">
                        @if (registerForm.get('alias')?.hasError('required')) {
                            <small class="error-message">El alias es requerido.</small>
                        }
                        @if (registerForm.get('alias')?.hasError('minlength')) {
                            <small class="error-message">El alias debe tener al menos 3 caracteres.</small>
                        }
                        @if (registerForm.get('alias')?.hasError('maxlength')) {
                            <small class="error-message">El alias no puede tener más de 10 caracteres.</small>
                        }
                        @if (registerForm.get('alias')?.hasError('pattern')) {
                            <small class="error-message">Solo se permiten letras, números, guiones y guiones bajos.</small>
                        }
                    </div>
                }
            </div>
        </div>

        <button type="submit" [disabled]="registerForm.invalid || loading">
            {{ loading ? 'Enviando...' : 'Enviar' }}
        </button>
    </form>
    
    <a (click)="goToLogin()" class="have-account" style="cursor: pointer;">Already have an account?</a>
    }
    </div>

    <div class="registration-success">
        @if(registrationSuccessful){
        <div class="success-message">
            <div class="success-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <h3>¡Registro exitoso!</h3>
            <p>Se envió un correo de validación a:</p>
            <p class="registered-email">{{ censurarCorreo(registeredEmail) }}</p>
            <p class="check-spam">Revisa tu bandeja de entrada y la carpeta de spam.</p>
        </div>

        <div class="resend-section">
            @if(showResendSection){
            <div class="resend-prompt">
                <h4>¿Todavía no recibiste tu correo?</h4>
                <p>Solicita uno nuevo</p>
            </div>
            
            <button 
                class="resend-btn"
                [disabled]="isResending || resendCooldown > 0"
                (click)="resendValidationEmail()">
                @if (!isResending && resendCooldown === 0) {
                    <span class="btn-content">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M1 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Reenviar correo
                    </span>
                }
                @if (isResending) {
                    <span class="btn-loading">
                        <div class="spinner"></div>
                        Reenviando...
                    </span>
                }
                @if (resendCooldown > 0) {
                    <span class="btn-cooldown">
                        Reenviar en {{ resendCooldown }}s
                    </span>
                }
            </button>

            <button class="login-btn" (click)="goToLogin()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2"/>
                    <polyline points="16,17 21,12 16,7" stroke="currentColor" stroke-width="2"/>
                    <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
                Ir al login
            </button>
            }
        </div>
        }
    </div>

