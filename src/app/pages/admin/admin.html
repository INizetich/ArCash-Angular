<app-theme-toggle></app-theme-toggle>
<app-back-button></app-back-button>

<div class="main">
    <div class="left-panel">
        <div class="logo">
           <app-brand-logo></app-brand-logo>
        </div>
    </div>

    <div class="right-panel">
        <!-- Vista Principal con Botones de Acceso -->
        @if (currentView === 'main') {
        <div class="formulario">
            <div class="admin-main-view">
                <h2>Panel de Administración</h2>
                
                <div class="buttons-container">
                    <button type="button" class="access-btn users-btn" (click)="showUsersListView()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Ver Usuarios Autenticados
                    </button>
                    
                    <button type="button" class="access-btn admin-btn" (click)="showCreateAdminView()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
                            <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Crear Nuevo Administrador
                    </button>
                </div>
            </div>
        </div>
        }

        <!-- Vista: Crear Administrador -->
        @if (currentView === 'create-admin') {
        <div class="formulario">
            <button type="button" class="nav-button" (click)="showUsersListView()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 6px;">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke="currentColor" stroke-width="2"/>
                </svg>
                Ver Usuarios Autenticados
            </button>
            
            <h2>Crear Nuevo Administrador</h2>

            <form [formGroup]="adminForm" (ngSubmit)="createAdmin()" novalidate>

                <div class="input-container">
                    <label>Nombre</label>
                    <div class="input-wrapper">
                        <input class="effect-1" 
                               type="text" 
                               formControlName="name" 
                               placeholder="Ingrese el nombre"
                               maxlength="50">
                        <span class="focus-border"></span>
                    </div>
                    <div>
                        @if (adminForm.get('name')?.invalid && adminForm.get('name')?.touched) {
                            <div class="error-container">
                                @if (adminForm.get('name')?.hasError('required')) {
                                    <small class="error-message">El nombre es requerido.</small>
                                }
                                @if (adminForm.get('name')?.hasError('pattern')) {
                                    <small class="error-message">El nombre solo puede contener letras y espacios.</small>
                                }
                                @if (adminForm.get('name')?.hasError('minlength')) {
                                    <small class="error-message">El nombre debe tener al menos 2 caracteres.</small>
                                }
                                @if (adminForm.get('name')?.hasError('maxlength')) {
                                    <small class="error-message">El nombre no puede tener más de 50 caracteres.</small>
                                }
                            </div>
                        }
                    </div>
                </div>

                <div class="input-container">
                    <label>Apellido</label>
                    <div class="input-wrapper">
                        <input class="effect-1" 
                               type="text" 
                               formControlName="lastName" 
                               placeholder="Ingrese el apellido"
                               maxlength="50">
                        <span class="focus-border"></span>
                    </div>
                    <div>
                        @if (adminForm.get('lastName')?.invalid && adminForm.get('lastName')?.touched) {
                            <div class="error-container">
                                @if (adminForm.get('lastName')?.hasError('required')) {
                                    <small class="error-message">El apellido es requerido.</small>
                                }
                                @if (adminForm.get('lastName')?.hasError('pattern')) {
                                    <small class="error-message">El apellido solo puede contener letras y espacios.</small>
                                }
                                @if (adminForm.get('lastName')?.hasError('minlength')) {
                                    <small class="error-message">El apellido debe tener al menos 2 caracteres.</small>
                                }
                                @if (adminForm.get('lastName')?.hasError('maxlength')) {
                                    <small class="error-message">El apellido no puede tener más de 50 caracteres.</small>
                                }
                            </div>
                        }
                    </div>
                </div>

                <div class="input-container">
                    <label>D.N.I</label>
                    <div class="input-wrapper">
                        <input class="effect-1" 
                               type="text" 
                               formControlName="dni" 
                               maxlength="8" 
                               placeholder="12345678"
                               (input)="onDniInput($event)">
                        <span class="focus-border"></span>
                    </div>
                    <div>
                        @if (adminForm.get('dni')?.invalid && adminForm.get('dni')?.touched) {
                            <div class="error-container">
                                @if (adminForm.get('dni')?.hasError('required')) {
                                    <small class="error-message">El DNI es requerido.</small>
                                }
                                @if (adminForm.get('dni')?.hasError('pattern')) {
                                    <small class="error-message">Debe ser un DNI de 8 dígitos sin puntos.</small>
                                }
                                @if (adminForm.get('dni')?.hasError('minlength')) {
                                    <small class="error-message">El DNI debe tener exactamente 8 dígitos.</small>
                                }
                                @if (adminForm.get('dni')?.hasError('maxlength')) {
                                    <small class="error-message">El DNI debe tener exactamente 8 dígitos.</small>
                                }
                            </div>
                        }
                    </div>
                </div>

                <div formGroupName="emails" class="email-group">
                    <div class="input-container">
                        <label>Email</label>
                        <div class="input-wrapper">
                            <input class="effect-1" 
                                   type="email" 
                                   formControlName="email" 
                                   placeholder="ejemplo@correo.com"
                                   maxlength="100">
                            <span class="focus-border"></span>
                        </div>
                        <div>
                            @if (adminForm.get('emails.email')?.invalid && adminForm.get('emails.email')?.touched) {
                                <div class="error-container">
                                    @if (adminForm.get('emails.email')?.hasError('required')) {
                                        <small class="error-message">El email es requerido.</small>
                                    }
                                    @if (adminForm.get('emails.email')?.hasError('email')) {
                                        <small class="error-message">Ingrese un formato de email válido.</small>
                                    }
                                    @if (adminForm.get('emails.email')?.hasError('pattern')) {
                                        <small class="error-message">El formato del email no es válido.</small>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="input-container">
                        <label>Confirmar Email</label>
                        <div class="input-wrapper">
                            <input class="effect-1" 
                                   type="email" 
                                   formControlName="confirmEmail" 
                                   placeholder="Confirme su email"
                                   maxlength="100">
                            <span class="focus-border"></span>
                        </div>
                        <div>
                            @if (adminForm.get('emails.confirmEmail')?.invalid && adminForm.get('emails.confirmEmail')?.touched) {
                                <div class="error-container">
                                    @if (adminForm.get('emails.confirmEmail')?.hasError('required')) {
                                        <small class="error-message">La confirmación del email es requerida.</small>
                                    }
                                    @if (adminForm.get('emails.confirmEmail')?.hasError('email')) {
                                        <small class="error-message">Ingrese un formato de email válido.</small>
                                    }
                                </div>
                            }
                            @if (adminForm.get('emails')?.hasError('emailMismatch') && adminForm.get('emails.confirmEmail')?.touched) {
                                <div class="error-container">
                                    <small class="error-message">Los emails no coinciden.</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div formGroupName="passwords" class="password-group">
                    <div class="input-container">
                        <label>Contraseña</label>
                        <div class="input-wrapper password-wrapper">
                            <input class="effect-1" 
                                   [type]="showPassword ? 'text' : 'password'" 
                                   formControlName="password"
                                   placeholder="8+ caracteres: mayúscula, minúscula, número, especial">
                            <button type="button" class="password-toggle" (click)="togglePasswordVisibility()" [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    @if (!showPassword) {
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                    } @else {
                                        <path d="m1 1 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M6.71 6.71C4.03 8.75 2 12 2 12s3 6 10 6c1.35 0 2.6-.3 3.71-.9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M14 14.12c-.55.19-1.14.29-1.76.29-2.48 0-4.5-2.02-4.5-4.5 0-.62.1-1.21.29-1.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M12 7c2.76 0 5 2.24 5 5 0 .28-.02.56-.07.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    }
                                </svg>
                            </button>
                            <span class="focus-border"></span>
                        </div>
                        <div>
                            @if (adminForm.get('passwords.password')?.invalid && adminForm.get('passwords.password')?.touched) {
                                <div class="error-container">
                                    @if (adminForm.get('passwords.password')?.hasError('required')) {
                                        <small class="error-message">La contraseña es requerida.</small>
                                    }
                                    @if (adminForm.get('passwords.password')?.hasError('minLength')) {
                                        <small class="error-message">Debe tener al menos 8 caracteres.</small>
                                    }
                                    @if (adminForm.get('passwords.password')?.hasError('lowercase')) {
                                        <small class="error-message">Debe contener al menos una letra minúscula.</small>
                                    }
                                    @if (adminForm.get('passwords.password')?.hasError('uppercase')) {
                                        <small class="error-message">Debe contener al menos una letra mayúscula.</small>
                                    }
                                    @if (adminForm.get('passwords.password')?.hasError('number')) {
                                        <small class="error-message">Debe contener al menos un número.</small>
                                    }
                                    @if (adminForm.get('passwords.password')?.hasError('specialChar')) {
                                        <small class="error-message">Debe contener al menos un carácter especial (!@#$%^&*...).</small>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="input-container">
                        <label>Confirmar Contraseña</label>
                        <div class="input-wrapper password-wrapper">
                            <input class="effect-1" 
                                   [type]="showConfirmPassword ? 'text' : 'password'" 
                                   formControlName="confirmPassword"
                                   placeholder="Repita su contraseña">
                            <button type="button" class="password-toggle" (click)="toggleConfirmPasswordVisibility()" [attr.aria-label]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    @if (!showConfirmPassword) {
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                    } @else {
                                        <path d="m1 1 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M6.71 6.71C4.03 8.75 2 12 2 12s3 6 10 6c1.35 0 2.6-.3 3.71-.9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M14 14.12c-.55.19-1.14.29-1.76.29-2.48 0-4.5-2.02-4.5-4.5 0-.62.1-1.21.29-1.76" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M12 7c2.76 0 5 2.24 5 5 0 .28-.02.56-.07.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    }
                                </svg>
                            </button>
                            <span class="focus-border"></span>
                        </div>
                        <div>
                            @if (adminForm.get('passwords')?.hasError('passwordMismatch') && adminForm.get('passwords.confirmPassword')?.touched) {
                                <div class="error-container">
                                    <small class="error-message">Las contraseñas no coinciden.</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="input-container">
                    <label>Nombre de usuario</label>
                    <div class="input-wrapper">
                        <input class="effect-1"  
                               type="text" 
                               formControlName="username"
                               placeholder="usuario123"
                               maxlength="10">
                        <span class="focus-border"></span>
                    </div>
                    <div>
                        @if (adminForm.get('username')?.invalid && adminForm.get('username')?.touched) {
                            <div class="error-container">
                                @if (adminForm.get('username')?.hasError('required')) {
                                    <small class="error-message">El nombre de usuario es requerido.</small>
                                }
                                @if (adminForm.get('username')?.hasError('minlength')) {
                                    <small class="error-message">El nombre de usuario debe tener al menos 3 caracteres.</small>
                                }
                                @if (adminForm.get('username')?.hasError('maxlength')) {
                                    <small class="error-message">El nombre de usuario no puede tener más de 10 caracteres.</small>
                                }
                                @if (adminForm.get('username')?.hasError('pattern')) {
                                    <small class="error-message">Solo se permiten letras, números, guiones y guiones bajos.</small>
                                }
                            </div>
                        }
                    </div>
                </div>

                <button type="submit" [disabled]="adminForm.invalid || loading">
                    {{ loading ? 'Creando...' : 'Crear Administrador' }}
                </button>

            </form>
        </div>
        }

        <!-- Vista: Lista de Usuarios -->
        @if (currentView === 'users-list') {
        <div class="formulario">
            <!-- Botón de navegación solo visible cuando no está cargando -->
            @if (!isLoadingUsers) {
            <button type="button" class="nav-button" (click)="showCreateAdminView()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 6px;">
                    <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Crear Nuevo Administrador
            </button>
            }
            
            <div class="usuarios-container">
                <!-- Título solo visible cuando no está cargando -->
                @if (!isLoadingUsers) {
                <h2>Usuarios Autenticados</h2>
                }
                
                <!-- Loading State con estilo del QR -->
                @if (isLoadingUsers) {
                <div class="search-loading-overlay">
                    <div class="search-loading-content">
                        <div class="search-spinner"></div>
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
                }
                
                <!-- Lista de Usuarios -->
                @if (!isLoadingUsers && users.length > 0) {
                <ul class="usuarios-lista">
                    @for (user of users; track user.id) {
                    <li class="usuario-item" (click)="openUserModal(user)">
                        <div class="usuario-datos">
                            <strong>{{user.name}} {{user.lastName}}</strong>
                            <span class="usuario-username">{{user.username}}</span>
                            <span class="usuario-dni">DNI: {{user.dni}}</span>
                            <span class="usuario-email">{{user.email}}</span>
                        </div>
                        <div class="action-buttons" (click)="$event.stopPropagation()">
                            <span class="status-indicator" [class]="user.active ? 'status-active' : 'status-inactive'">
                                {{user.active ? 'Activo' : 'Inactivo'}}
                            </span>
                            @if (user.active) {
                            <button 
                                class="inhabilitar-btn"
                                (click)="openConfirmModal(user)">
                                Deshabilitar
                            </button>
                            } @else {
                            <button 
                                class="habilitar-btn"
                                (click)="openConfirmModal(user)">
                                Habilitar
                            </button>
                            }
                        </div>
                    </li>
                    }
                </ul>
                }
                
                <!-- Sin Usuarios -->
                @if (!isLoadingUsers && users.length === 0) {
                <div class="no-users">
                    <p>No hay usuarios autenticados para mostrar.</p>
                </div>
                }
            </div>
        </div>
        }
    </div>
</div>

<!-- Modal de Información de Usuario -->
@if (selectedUser) {
<div class="modal user-modal" [class.show]="showUserModal">
    <div class="modal-content user-modal-content">
        <button class="close-modal" (click)="closeUserModal()">×</button>
        <h3>Información del Usuario</h3>
        
        <div class="user-info">
            <div class="user-info-item">
                <span class="user-info-label">Nombre Completo:</span>
                <span class="user-info-value">{{selectedUser.name}} {{selectedUser.lastName}}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Nombre de Usuario:</span>
                <span class="user-info-value">{{selectedUser.username}}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">DNI:</span>
                <span class="user-info-value">{{selectedUser.dni}}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Email:</span>
                <span class="user-info-value">{{selectedUser.email}}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">ID de Cuenta:</span>
                <span class="user-info-value">{{selectedUser.idAccount || 'No asignado'}}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Estado:</span>
                <span class="user-info-value" [class]="selectedUser.active ? 'estado-si' : 'estado-no'">
                    {{selectedUser.active ? 'Activo' : 'Inactivo'}}
                </span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Habilitado:</span>
                <span class="user-info-value" [class]="selectedUser.enabled ? 'estado-si' : 'estado-no'">
                    {{selectedUser.enabled ? 'Sí' : 'No'}}
                </span>
            </div>
        </div>
        
        <div class="modal-actions">
            @if (selectedUser.active) {
            <button 
                class="inhabilitar-btn"
                (click)="openConfirmModal(selectedUser)">
                Deshabilitar Usuario
            </button>
            } @else {
            <button 
                class="habilitar-btn"
                (click)="openConfirmModal(selectedUser)">
                Habilitar Usuario
            </button>
            }
        </div>
    </div>
</div>
}

<!-- Modal de Confirmación Personalizado -->
@if (userToToggle) {
<div class="modal confirmation-modal" [class.show]="showConfirmModal">
    <div class="modal-content">
        <h3>Confirmar Acción</h3>
        <p>
            ¿Está seguro que desea {{userToToggle.active ? 'deshabilitar' : 'habilitar'}} 
            al usuario <strong>{{userToToggle.name}} {{userToToggle.lastName}}</strong>?
        </p>
        <div class="confirmation-buttons">
            <button class="confirm-btn" (click)="confirmToggleUser()">
                {{userToToggle.active ? 'Deshabilitar' : 'Habilitar'}}
            </button>
            <button class="cancel-btn" (click)="closeConfirmModal()">
                Cancelar
            </button>
        </div>
    </div>
</div>
}