@if (isValidatingToken) {
<div id="validation-loader-overlay" role="status">
  <div class="validation-loader-container">
    <div class="loading-logo-container">
      <svg class="brand-mark" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M60 20 L100 40 V80 L60 100 L20 80 V40 Z" class="vault-shape" />
        <circle cx="60" cy="60" r="18" class="security-core" />
        <path d="M60 42 L60 78 M48 60 L72 60" class="access-cross" />
      </svg>
      <div class="spinner-circle"></div>
    </div>
    <div class="loading-brand">
      <h1>AR<span>Cash</span></h1>
      <p class="brand-tagline">The best virtual wallet</p>
      <p class="loading-text" aria-live="polite">Validando enlace de recuperación...</p>
    </div>
  </div>
</div>
}

<app-theme-toggle></app-theme-toggle>

@if (!isValidatingToken) {
<main class="main">
  <aside class="left-panel">
    <app-brand-logo></app-brand-logo>
  </aside>

  <div class="right-panel">
    <section class="formulario">
      <h2>Restablecer contraseña</h2>
      @if (token) {
      <div class="form-container">
        @if (error) {
        <div class="error" role="alert">{{ error }}</div>
        }
        <form [formGroup]="resetForm" (ngSubmit)="onSubmit()" novalidate>
          <div formGroupName="passwords">
            <div class="input-container">
              <label for="new-password">Nueva contraseña</label>
              <div class="input-wrapper">
                <input class="effect-1" [type]="showPassword ? 'text' : 'password'" formControlName="password"
                  autocomplete="new-password" id="new-password" /> <span class="focus-border"></span>
                <button type="button" class="password-toggle" (click)="togglePasswordVisibility()"
                  [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    @if (!showPassword) {
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" />
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" />
                    }
                    @if (showPassword) {
                    <path d="m1 1 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M6.71 6.71C4.03 8.75 2 12 2 12s3 6 10 6c1.35 0 2.6-.3 3.71-.9" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" />
                    <path d="M14 14.12c-.55.19-1.14.29-1.76.29-2.48 0-4.5-2.02-4.5-4.5 0-.62.1-1.21.29-1.76"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M12 7c2.76 0 5 2.24 5 5 0 .28-.02.56-.07.83" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" />
                    }
                  </svg>
                </button>
              </div>
              @if (resetForm.get('passwords.password')?.invalid && resetForm.get('passwords.password')?.touched) {
              <div class="error-container" role="alert">
                @if (resetForm.get('passwords.password')?.hasError('required')) {
                <small class="error-message">La contraseña es obligatoria.</small>
                }
                @if (resetForm.get('passwords.password')?.hasError('minLength')) {
                <small class="error-message">Debe tener al menos 8 caracteres.</small>
                }
                @if (resetForm.get('passwords.password')?.hasError('lowercase')) {
                <small class="error-message">Debe contener al menos una letra minúscula.</small>
                }
                @if (resetForm.get('passwords.password')?.hasError('uppercase')) {
                <small class="error-message">Debe contener al menos una letra mayúscula.</small>
                }
                @if (resetForm.get('passwords.password')?.hasError('number')) {
                <small class="error-message">Debe contener al menos un número.</small>
                }
                @if (resetForm.get('passwords.password')?.hasError('specialChar')) {
                <small class="error-message">Debe contener al menos un carácter especial (!@#$%^&*...).</small>
                }
              </div>
              }
            </div>
            <div class="input-container">
              <label for="confirm-password">Confirmar contraseña</label>
              <div class="input-wrapper">
                <input class="effect-1" [type]="showConfirmPassword ? 'text' : 'password'"
                  formControlName="confirmPassword" autocomplete="new-password" id="confirm-password" /> <span class="focus-border"></span>
                <button type="button" class="password-toggle" (click)="toggleConfirmPasswordVisibility()"
                  [attr.aria-label]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    @if (!showConfirmPassword) {
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" />
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" />
                    }
                    @if (showConfirmPassword) {
                    <path d="m1 1 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M6.71 6.71C4.03 8.75 2 12 2 12s3 6 10 6c1.35 0 2.6-.3 3.71-.9" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" />
                    <path
                      d="M14 14.12c-.55.19-1.14.29-1.76.29-2.48 0-4.5-2.02-4.5-4.5 0-.62.1-1.21.29-1.76"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M12 7c2.76 0 5 2.24 5 5 0 .28-.02.56-.07.83" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" />
                    }
                  </svg>
                </button>
              </div>
              @if (resetForm.get('passwords.confirmPassword')?.invalid &&
              resetForm.get('passwords.confirmPassword')?.touched) {
              <div class="error-container" role="alert">
                @if(resetForm.get('passwords.confirmPassword')?.hasError('required')){
                <small class="error-message">Debe confirmar la contraseña.</small>
                }
              </div>
              }
              @if (resetForm.get('passwords')?.hasError('passwordMismatch') &&
              resetForm.get('passwords.confirmPassword')?.touched) {
              <div class="error-container" role="alert">
                <small class="error-message">Las contraseñas no coinciden.</small>
              </div>
              }
            </div>
          </div>
          <button type="submit" [disabled]="!canSubmit()">
            @if (!isLoading) {
            <span>Cambiar contraseña</span>
            } @else {
            <span class="loading-text">
              <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3" />
                <path d="M12 2A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none" />
              </svg>
            </span>
            }
          </button>
        </form>
      </div>
      }
    </section>
  </div>
  <footer class="global-footer">
    <p>ArCash™ | Virtual Wallet</p>
    <a href="https://mail.google.com/mail/?view=cm&fs=1&to=helparcash2025@gmail.com" target="_blank"
      class="email-link">helparcash2025@gmail.com</a>
  </footer>
  </main>
}